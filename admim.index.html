<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Sam Enthnan AFB</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-dark: #001f3f;
            --navy-medium: #003366;
            --navy-light: #004d99;
            --accent-gold: #d4af37;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #001f3f 50%, #003366 100%);
            color: #fff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem;
            display: block;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--navy-dark);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            font-size: 1.1rem;
            color: var(--navy-medium);
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            border-color: var(--navy-medium);
            box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
            outline: none;
            transform: translateY(-2px);
        }

        .login-btn {
            background: linear-gradient(135deg, var(--navy-dark), var(--navy-medium));
            color: white;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 31, 63, 0.4);
        }

        .back-btn {
            background: white;
            color: var(--navy-dark);
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid #d1d5db;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%;
        }

        .back-btn:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .error-message {
            color: #ef4444;
            font-weight: 600;
            margin-top: 1rem;
            display: none;
        }

        .security-notice {
            background: #f9fafb;
            border-left: 4px solid var(--accent-gold);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            text-align: left;
        }

        .security-notice h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--navy-dark);
            margin: 0 0 0.5rem 0;
        }

        .security-notice p {
            font-size: 0.8rem;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <img src="https://i.imgur.com/74e5Ijv.jpeg" alt="Unit Logo" class="logo"/>
        <h1 class="login-title">Admin Portal</h1>
        <h2 class="login-subtitle">Sam Enthnan Air Force Base</h2>
        
        <input type="password" id="adminPassword" class="password-input" placeholder="Enter Admin Password" autocomplete="off">
        
        <button class="login-btn" onclick="login()">üîë Login to Dashboard</button>
        
        <div class="error-message" id="errorMessage">‚ùå Invalid password! Please try again.</div>
        
        <button class="back-btn" onclick="goBack()">‚Üê Back to Main Form</button>
        
        <div class="security-notice">
            <h4>üîí Security Notice</h4>
            <p>This portal is for authorized personnel only. All access attempts are logged.</p>
        </div>
    </div>

    <script>
       // ==================== ADMIN DASHBOARD FUNCTIONS ====================

let allPersonnelData = [];
let currentFilter = 'all';

function showAdminDashboard() {
  document.getElementById('adminModal').style.display = 'block';
  loadAllData();
}

function closeAdminDashboard() {
  document.getElementById('adminModal').style.display = 'none';
}

async function loadAllData() {
  try {
    console.log("Loading data from Firebase...");
    document.getElementById('adminData').innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 1.1rem;">üîÑ Loading data from Firebase...</p>';
    
    const snapshot = await db.collection('personnel').orderBy('timestamp', 'desc').get();
    allPersonnelData = [];
    
    console.log("Firebase returned", snapshot.size, "documents");
    
    snapshot.forEach(doc => {
      const data = doc.data();
      allPersonnelData.push({
        id: doc.id,
        ...data
      });
    });
    
    console.log("Processed", allPersonnelData.length, "records");
    updateDashboard();
    
  } catch (error) {
    console.error('Error loading data:', error);
    document.getElementById('adminData').innerHTML = `
      <div style="background: #fee2e2; color: #dc2626; padding: 1rem; border-radius: 8px; text-align: center;">
        <strong>‚ùå Error loading data:</strong><br>
        ${error.message}<br><br>
        <button onclick="loadAllData()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Retry Loading
        </button>
      </div>
    `;
  }
}

function filterByCadre(cadre) {
  currentFilter = cadre;
  updateDashboard();
}

function updateDashboard() {
  const filteredData = currentFilter === 'all' 
    ? allPersonnelData 
    : allPersonnelData.filter(item => item.cadre === currentFilter);
  
  // Update statistics
  const total = allPersonnelData.length;
  const airmen = allPersonnelData.filter(item => item.cadre === 'airmen').length;
  const officers = allPersonnelData.filter(item => item.cadre === 'officer').length;
  
  document.getElementById('stats').innerHTML = `
    <strong style="font-size: 1.2rem;">üìä LIVE STATISTICS:</strong><br>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
      <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold;">${total}</div>
        <div>Total Records</div>
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold;">${airmen}</div>
        <div>Airmen</div>
      </div>
      <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; text-align: center;">
        <div style="font-size: 2rem; font-weight: bold;">${officers}</div>
        <div>Officers</div>
      </div>
    </div>
  `;
  
  // Display data
  if (filteredData.length === 0) {
    document.getElementById('adminData').innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 1.1rem;">No data found for the selected filter.</p>';
    return;
  }
  
  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
  `;
  
  filteredData.forEach((person, index) => {
    // Format timestamp safely
    let submissionDate = 'Unknown';
    try {
      if (person.timestamp && person.timestamp.toDate) {
        submissionDate = new Date(person.timestamp.toDate()).toLocaleDateString();
      } else if (person.submission_date) {
        submissionDate = new Date(person.submission_date).toLocaleDateString();
      }
    } catch (e) {
      console.log("Date error:", e);
    }
    
    html += `
      <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f3f4f6;">
          <strong style="color: ${person.cadre === 'airmen' ? '#0066cc' : '#004d99'}; font-size: 1.1rem; background: ${person.cadre === 'airmen' ? '#e6f3ff' : '#e6f0ff'}; padding: 4px 12px; border-radius: 20px;">${person.cadre ? person.cadre.toUpperCase() : 'UNKNOWN'}</strong>
          <small style="color: #6b7280; font-weight: 600;">${submissionDate}</small>
        </div>
        <div style="display: grid; gap: 0.5rem;">
          <div><strong style="color: var(--navy-dark);">Service No:</strong> <span style="color: #374151; font-weight: 600;">${person.svc_no || 'N/A'}</span></div>
          <div><strong style="color: var(--navy-dark);">Rank:</strong> <span style="color: #374151; font-weight: 600;">${person.rank || 'N/A'}</span></div>
          <div><strong style="color: var(--navy-dark);">Name:</strong> <span style="color: #374151; font-weight: 600;">${person.fullname || person.name || 'N/A'}</span></div>
          <div><strong style="color: var(--navy-dark);">Unit:</strong> <span style="color: #374151; font-weight: 600;">${person.present_unit || 'N/A'}</span></div>
          <div><strong style="color: var(--navy-dark);">Phone:</strong> <span style="color: #374151; font-weight: 600;">${person.phone || 'N/A'}</span></div>
        </div>
        
        <!-- File indicators -->
        <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
          <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">Attachments:</div>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            ${person.svc_id_card ? `<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üì∑ ID Card</span>` : ''}
            ${person.authority_letter ? `<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üìÑ Authority</span>` : ''}
            ${person.allocation_letter ? `<span style="background: #8b5cf6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üìã Allocation</span>` : ''}
            ${person.dependant_photos && person.dependant_photos.length > 0 ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">üñºÔ∏è Photos (${person.dependant_photos.length})</span>` : ''}
          </div>
        </div>
        
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
          <button onclick="viewDetails('${person.id}')" style="background: var(--navy-dark); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
            üëÅÔ∏è View Details
          </button>
          <button onclick="deleteRecord('${person.id}')" style="background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  document.getElementById('adminData').innerHTML = html;
}

// ... keep your existing downloadFile, exportToCSV, viewDetails, deleteRecord functions
    </script>
</body>

</html>
